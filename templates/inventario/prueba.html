{% extends 'base.html' %}
{% load static %}

{% block content %}
  <link rel="stylesheet" href="{% static 'css/inventario.css' %}">
<div class="container-fluid mt-4">
  <div class="row">
    <aside class="col-lg-4 inventory-sidebar">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-start">
            <h5 class="card-title me-auto">Control de Inventario</h5>
            <a href="{% url 'pos_ventas' %}" class="btn btn-sm btn-success">Ir a Ventas</a>
          </div>
          <p class="text-muted small">Registra ingresos y egresos de stock</p>

          {% if message %}
            <div class="alert alert-success">{{ message }}</div>
          {% endif %}

          <form id="inventory-form" method="post">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Buscar producto</label>
              <input id="product-search" class="form-control" placeholder="Escribe nombre y selecciona">
              <select name="producto_id" id="producto-select" class="form-select mt-2">
                <option value="">-- selecciona --</option>
                {% for p in productos %}
                  <option value="{{ p.pk }}">{{ p.nombre }} (stock: {{ p.stock_actual|default:0 }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="row">
              <div class="col-6 mb-3">
                <label class="form-label">Acción</label>
                <select name="action" class="form-select">
                  <option value="ingreso">Ingreso</option>
                  <option value="egreso">Egreso</option>
                </select>
              </div>
              <div class="col-6 mb-3">
                <label class="form-label">Cantidad</label>
                <input name="cantidad" type="number" min="1" value="1" class="form-control">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Proveedor (opcional)</label>
              <input name="proveedor" class="form-control">
            </div>

            <div class="mb-3">
              <label class="form-label">Documento / Nº (opcional)</label>
              <input name="documento" class="form-control">
            </div>

            <div class="mb-3 d-grid">
              <button id="submit-inventory" class="btn btn-primary">Registrar movimiento</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <section class="col-lg-8 inventory-main">
      {% if low_stock.exists %}
        <div class="alert alert-warning">Hay productos con stock por debajo del mínimo.</div>
      {% endif %}

      <div class="card movimientos-card">
        <div class="card-body">
          <h5 class="card-title">Movimientos recientes</h5>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Producto</th>
                  <th>Cantidad</th>
                  <th>Tipo</th>
                </tr>
              </thead>
              <tbody id="movimientos-body">
                {% for m in movimientos %}
                <tr>
                  <td>{{ m.fecha }}</td>
                  <td>{{ m.productos.nombre }}</td>
                  <td>{{ m.cantidad }}</td>
                  <td>
                    {% if m.tipo_movimiento == 'ingreso' %}
                      <i class="bi bi-box-arrow-in-right text-success" data-bs-toggle="tooltip" data-bs-title="{{ m.tipo_movimiento|capfirst }} de productos"></i>
                      {% else %}
                      <i class="bi bi-box-arrow-left text-warning" data-bs-toggle="tooltip" data-bs-title="{{ m.tipo_movimiento|capfirst }} de productos"></i>
                    {% endif %}                    
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center small text-muted">No hay movimientos registrados.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <nav class="mt-2">
            <ul class="pagination pagination-sm">
              {% if movimientos.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ movimientos.previous_page_number }}{% if query %}&q={{ query }}{% endif %}">&laquo;</a></li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
              {% endif %}
              <li class="page-item disabled"><span class="page-link">Página {{ movimientos.number }} de {{ movimientos.paginator.num_pages }}</span></li>
              {% if movimientos.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ movimientos.next_page_number }}{% if query %}&q={{ query }}{% endif %}">&raquo;</a></li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
              {% endif %}
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <script src="{% static 'js/inventario.js' %}"></script>

</div>
{% endblock %}
